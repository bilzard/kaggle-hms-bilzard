# MIL(Multi Instance Learning)の方針について

## 概要

EDAの結果によると、このコンペでは大部分のラベルがEEGにに対して1つのラベルしか与えられていない。つまりweak labelであり、MIL(Multi Instance Learning)の設定に近い。

つまり、EEG単位のラベルを愚直に使うと、訓練時に本来ラベルとは無関係の特徴に対してラベルノイズを学習してしまうことになる。この仮説によりpublic discussionで報告されているいくつかの現象も説明できる[1, 2]。

本稿では本コンペにおけるラベルノイズの影響を軽減する方法について議論する。

## 仮説と検証方法

### 仮説

1. trainデータのEEGにはラベルと無関係な特徴を含んでいる。このため、trainサンプルの50secのチャンクに対してEEG単位のラベルを使って学習したモデルはCV/LBでsuboptimalな性能を示す。

### 検証方法

学習時にモデルがラベルと無関係な特徴とラベルと関連性の高い特徴を区別できれば、ラベルを愚直に与えるモデルと比べてCV/LB双方の改善が見込めるはずである。


## 可能な対応策について

まず、最もナイーブな方法は、モデルに入力するEEGの系列長を50secよりも長くすることである。ただし、サンプルによっては数時間にも及ぶ長大な系列があり、全系列を入力することは計算量的にあまりスマートなやり方ではない。

そこで、大きく以下の2つの方法が有望である。

1. **離散的なbag**: 1つのEEGに対して複数の50secのチャンクをサンプルし、個々のサンプルをモデルに入力する。同一EEGからサンプルされたサンプルに対して、モデルの出力するembeddingをmaxやsoftmaxなど順序に依存しないaggregationの仕方で集約し、EEGあたりのembeddingを求めた上でheadに流す。推論時は単一のサンプルのembeddingをheadに流す。（validation setもtrainと同じweakラベルなので、localでの評価時はtrainと同様の方法でEEG単位のラベルを予測する）
2. **連続的なbag**: チャンクのサンプル方法は1と同じだが、spectrogramを個別にモデルに入力するのでなく、時間方向に結合したspectrogramをモデルに入力する。集約時はサンプル方向でなく、時間方向の次元で1同様の方法で集約する。

## 議論

### 1のメリット

* サンプルの順序に依存しないモデリングが可能(2の場合だと画像を横に繋げている以上、モデルの予測結果はチャンクをつなげる順序に依存する。ただし、ランダムサンプリングによりこの影響は多少軽減されることが期待できる)

### 2のメリット

* 2Dモデルの順方向の伝搬において、重複する部分の計算が並列化されるので計算量的に効率的
* チャンク内部でもattentionを適用できる（1の場合でも、2段階のattentionを噛ませれば実現は可能。この場合、モデリングはやや複雑になる。）

### 方針

2の方法の方が柔軟なモデリングができそうだが、まずは実装が単純な1の方法を試してそもそも仮説の真偽を証明する。

## 実験方法

### train

- 1つのEEGに対して50secのチャンクをランダムにS個サンプルする。
- S個のサンプルはバッチ方向にstackし、2Dモデルに個別に加える
- 2Dモデルの出力を計算後に再びS個のサンプルごとにバッチを分割する。S個embeddingに対してそれぞれattentionスコアを計算し、集約する。
- 集約したembeddingをheadに入力する

$$
z_i = \sum_{s \in S} a_{i, s} z_{i, s}, \text{ where } \sum_s{a_{i, s}} = 1.
$$

### validation

- 1つのEEGからsliding windowにより$S_i$個のサンプルを抽出する
- $S_i$個のサンプルのそれぞれについて、embeddingをtraining時と同じ方法で集約してheadに入力する

#### 推論時の注意点

$S_i$はEEGごとに異なるため、推論時には以下のいずれかの工夫が必要。

1. **infer per chunk**: batch sizeを1にして1つのEEGごとに2Dモデルに入力する
1. **3-stageの推論**: headの直前までは通常の並列処理により(B>1)推論し、EEGごとにembeddingとattention scoreのキャッシュを生成する。次に、EEGごとにB=1でembeddingの集約を行い、eegごとのembeddingを計算する。最後に再びB>1でEEGごとに推論をする。
1. **固定のサンプリング**: 多少雑ではあるが、trainと同じくEEGからS個固定でサンプリングしても良い。この場合、epochごとのサンプルの選択方法に差異が生じないようにvalidationまでに乱数seedを固定するなどの工夫が必要。

#### 方針

推論時間が十分に短くできる（30秒以内）なら1でも良い。
それよりも時間がかかかるなら2の方法を検討する。

3はCVの結果が確率的になるので一旦保留（bootstrapにより複数回サンプリングするならそれなりに信用できるスコアが得られるかも。2が想定以上に難しいなら検討する）。

### infer

- B>1で50secのチャンクごとに2Dモデルに入力する。EEGごとに1つのchunkをもつため集約は行わず、embeddingを直接headに入力する

## Reference

- [1] https://www.kaggle.com/competitions/hms-harmful-brain-activity-classification/discussion/477461
- [2] https://www.kaggle.com/competitions/hms-harmful-brain-activity-classification/discussion/477498